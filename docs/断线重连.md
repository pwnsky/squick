# 断线重连

断线重连分两种情况，运行中和意外退出。运行中可能出现弱网络或后台运行，弱网络是网络特别卡，卡网络断开连接了，后台运行网络没有断线，但没有进行收发消息；第二种是意外退出，客户端直接关闭掉或闪退。

目前服务器实现，在代理服务器上，如果出现网络意外断开连接，玩家会在代理服务器上维持5分钟的保活时间，超过5分钟，玩家会真正离线，这时候玩家所在的房间和和游戏对局会销毁掉。玩家在客户端中通过按钮退出游戏，请求相应的RPC调用代理服务器，以实现立即离线。



### 1. 弱网络或后台运行 

已进入游戏大厅或正在游戏中网络断开连接了，需要客户端自行判断网络是否断开，这里分两种情况讨论。

#### 网络已断开

##### 已进入游戏大厅

1. 通过连接秘钥请求连接代理服务器
2. 请求进入大厅

##### 已进入游戏网络已断开

1. 通过连接秘钥请求连接代理服务器
2. 请求加入游戏



#### 网络没有断开

该情况下网络没有断开连接，该过程不需要重新连接代理服务器，服务器采用非阻塞发送数据包，为了发送效率，在多次未成功发送的数据包，会舍弃掉该包，客户端在网络差的情况下有一定概率收不到数据包，需要重新调用进入大厅或加入游戏实现同步。



### 2. 客户端意外退出

客户端直接关闭了，客户端先判断登录秘钥是否过期，过期重新登录，没过期再判断代理连接秘钥是否过期，过期重新选择选择区服进入区服，没过期直接连接代理服务器，请求进入大厅。如果存在游戏对局，那么响应包中会有游戏对局的信息，再次加入游戏即可。



ref: https://zhuanlan.zhihu.com/p/326755565